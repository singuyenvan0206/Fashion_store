<Window x:Class="WpfApp1.InvoiceManagementWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:oxy="http://oxyplot.org/wpf"
        Title="Quản Lý Hóa Đơn" Height="800" Width="1280"
        WindowStartupLocation="CenterScreen"
        KeyDown="Window_KeyDown">
	<Grid Background="#F5F5F5">
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="*"/>
			<RowDefinition Height="Auto"/>
		</Grid.RowDefinitions>

		<!-- Header -->
		<Border Grid.Row="0" Background="#1CB5E0" Padding="20">
			<Grid>
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="*"/>
					<ColumnDefinition Width="Auto"/>
				</Grid.ColumnDefinitions>
				<StackPanel Orientation="Horizontal" VerticalAlignment="Center">
					<TextBlock Text="🧾 Quản Lý Hóa Đơn" FontSize="26" FontWeight="Bold" Foreground="White"/>
					<TextBlock Text=" - Tạo hóa đơn bán hàng" FontSize="14" Foreground="#E3F2FD" Margin="10,0,0,0"/>
                </StackPanel>
				<StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
					<TextBlock Text="👤 Khách hàng:" Foreground="White" VerticalAlignment="Center" FontWeight="SemiBold"/>
					<ComboBox x:Name="CustomerComboBox" Width="280" Height="32" DisplayMemberPath="Name" SelectedValuePath="Id" Margin="8,0,0,0" FontSize="14" SelectionChanged="CustomerComboBox_SelectionChanged"/>
					<Button x:Name="OpenHistoryButton" Content="📜 Lịch sử" Width="120" Height="32" Margin="12,0,0,0" 
							Background="#FF9800" Foreground="White" FontWeight="SemiBold" Click="OpenHistoryButton_Click"/>
					<Border Background="#1496C6" CornerRadius="6" Padding="8,4" Margin="12,0,0,0" VerticalAlignment="Center">
						<StackPanel Orientation="Horizontal" VerticalAlignment="Center">
							<TextBlock Text="🏷️ " Foreground="White"/>
							<TextBlock x:Name="LoyaltyTierTextBlock" Text="Regular" Foreground="White" FontWeight="Bold"/>
							<TextBlock Text=" • " Foreground="#E3F2FD"/>
							<TextBlock x:Name="LoyaltyPointsTextBlock" Text="0 điểm" Foreground="#E3F2FD"/>
						</StackPanel>
					</Border>
				</StackPanel>
			</Grid>
		</Border>

		<!--Main Content -->
		<Grid Grid.Row="1" Margin="20">
			<Grid.RowDefinitions>
				<RowDefinition Height="Auto"/>
				<RowDefinition Height="*"/>
				<RowDefinition Height="200"/>
			</Grid.RowDefinitions>
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="380"/>
			</Grid.ColumnDefinitions>

			<!-- Product selector -->
			<Border Grid.Row="0" Background="White" CornerRadius="12" Padding="16" Margin="0,0,0,12" BorderBrush="#E0E0E0" BorderThickness="1">
				<Grid>
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="100"/>
						<ColumnDefinition Width="120"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>
					<StackPanel Grid.Column="0" Margin="0,0,12,0">
						<TextBlock Text="🔍 Chọn sản phẩm" FontWeight="SemiBold" Margin="0,0,0,4" Foreground="#333"/>
						<ComboBox x:Name="ProductComboBox" Height="36" IsEditable="True" StaysOpenOnEdit="True"
								DisplayMemberPath="Name" SelectedValuePath="Id" SelectionChanged="ProductComboBox_SelectionChanged"
								IsTextSearchEnabled="True" FontSize="14" Padding="8,6" ToolTip="Gõ để tìm sản phẩm theo tên hoặc mã"/>
					</StackPanel>
					<StackPanel Grid.Column="1" Margin="0,0,8,0" VerticalAlignment="Bottom">
						<TextBlock Text="📦 Số lượng" FontWeight="SemiBold" Margin="0,0,0,4" Foreground="#333"/>
						<TextBox x:Name="QuantityTextBox" Height="36" Text="1" FontSize="14" Padding="8,6" TextAlignment="Center" ToolTip="Số lượng"/>
					</StackPanel>
					<StackPanel Grid.Column="2" Margin="0,0,8,0" VerticalAlignment="Bottom">
						<TextBlock Text="💰 Đơn giá" FontWeight="SemiBold" Margin="0,0,0,4" Foreground="#333"/>
						<TextBox x:Name="UnitPriceTextBox" Height="36" FontSize="14" Padding="8,6" TextAlignment="Right" ToolTip="Đơn giá bán"/>
					</StackPanel>
					<Button x:Name="AddItemButton" Grid.Column="3" Content="➕ Thêm vào hóa đơn" Width="180" Height="40" 
							Background="#4CAF50" Foreground="White" FontWeight="SemiBold" FontSize="14" 
							Click="AddItemButton_Click" VerticalAlignment="Bottom" ToolTip="Thêm sản phẩm vào hóa đơn (Enter)"/>
				</Grid>
			</Border>

			<!-- Items grid -->
			<Border Grid.Row="1" Background="White" CornerRadius="12" BorderBrush="#E0E0E0" BorderThickness="1">
				<Grid>
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="*"/>
					</Grid.RowDefinitions>
					
					<!-- Grid Header -->
					<Border Grid.Row="0" Background="#F8F9FA" CornerRadius="12,12,0,0" Padding="16,12">
						<TextBlock Text="🛒 Danh sách sản phẩm trong hóa đơn" FontSize="16" FontWeight="Bold" Foreground="#333"/>
					</Border>
					
					<DataGrid Grid.Row="1"
					          x:Name="InvoiceItemsDataGrid"
					          AutoGenerateColumns="False"
					          CanUserAddRows="False"
					          SelectionMode="Single"
					          Background="White"
					          RowHeaderWidth="0"
					          ScrollViewer.VerticalScrollBarVisibility="Auto"
					          ScrollViewer.HorizontalScrollBarVisibility="Auto"
					          EnableRowVirtualization="True"
					          EnableColumnVirtualization="True"
					          BorderThickness="0"
					          GridLinesVisibility="Horizontal"
					          HeadersVisibility="Column">
				<DataGrid.Resources>
					<Style TargetType="TextBlock" x:Key="RightAlignedCell">
						<Setter Property="TextAlignment" Value="Right"/>
					</Style>
				</DataGrid.Resources>
				<DataGrid.Columns>
					<DataGridTextColumn Header="#" Binding="{Binding RowNumber}" Width="50" IsReadOnly="True"/>
					<DataGridTextColumn Header="Sản phẩm" Binding="{Binding ProductName}" Width="*" IsReadOnly="True"/>
					<DataGridTextColumn Header="Đơn giá" Binding="{Binding UnitPrice, StringFormat=N0}" Width="140" IsReadOnly="True">
						<DataGridTextColumn.ElementStyle>
							<Style TargetType="TextBlock">
								<Setter Property="TextAlignment" Value="Right"/>
							</Style>
						</DataGridTextColumn.ElementStyle>
					</DataGridTextColumn>
					<DataGridTextColumn Header="SL" Binding="{Binding Quantity}" Width="100" IsReadOnly="True">
						<DataGridTextColumn.ElementStyle>
							<Style TargetType="TextBlock">
								<Setter Property="TextAlignment" Value="Right"/>
							</Style>
						</DataGridTextColumn.ElementStyle>
					</DataGridTextColumn>
					<DataGridTextColumn Header="Thành tiền" Binding="{Binding LineTotal, StringFormat=N0}" Width="180" IsReadOnly="True">
						<DataGridTextColumn.ElementStyle>
							<Style TargetType="TextBlock">
								<Setter Property="TextAlignment" Value="Right"/>
							</Style>
						</DataGridTextColumn.ElementStyle>
					</DataGridTextColumn>
					<DataGridTemplateColumn Header="⚙️ Thao tác" Width="240">
						<DataGridTemplateColumn.CellTemplate>
							<DataTemplate>
								<StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
									<Button Content="➕" Width="32" Height="28" Margin="0,0,4,0" 
											Background="#4CAF50" Foreground="White" FontWeight="Bold" Click="IncreaseQtyButton_Click"/>
									<Button Content="➖" Width="32" Height="28" Margin="0,0,4,0" 
											Background="#FF9800" Foreground="White" FontWeight="Bold" Click="DecreaseQtyButton_Click"/>
									<Button Content="🗑️" Width="50" Height="28" 
											Background="#F44336" Foreground="White" FontWeight="Bold" Click="RemoveItemButton_Click"/>
								</StackPanel>
							</DataTemplate>
						</DataGridTemplateColumn.CellTemplate>
					</DataGridTemplateColumn>
				</DataGrid.Columns>
			</DataGrid>
				</Grid>
			</Border>

			<!-- Mini summary chart removed for a cleaner interface -->

			<!-- Totals sidebar on the right -->
			<Border Grid.Row="0" Grid.Column="1" Grid.RowSpan="3" Background="White" CornerRadius="12" Padding="20" Margin="12,0,0,0" BorderBrush="#E0E0E0" BorderThickness="1">
				<Grid>
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
					</Grid.ColumnDefinitions>
					<!-- Totals only -->
					<Border Grid.Column="0" Background="#F8F9FA" CornerRadius="8" Padding="16">
						<Grid>
							<Grid.RowDefinitions>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
							</Grid.RowDefinitions>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="120"/>
							</Grid.ColumnDefinitions>

							<TextBlock Grid.Row="0" Grid.Column="0" Text="💰 Tạm tính:" HorizontalAlignment="Left" Margin="0,0,8,8" FontWeight="SemiBold"/>
							<TextBlock x:Name="SubtotalTextBlock" Grid.Row="0" Grid.Column="1" Text="0₫" HorizontalAlignment="Left" TextAlignment="Left" FontSize="16" FontWeight="Bold" Foreground="#2E7D32"/>

							<StackPanel Grid.Row="1" Grid.ColumnSpan="2" Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,8,0,8" Height="auto">
								<TextBlock Text="📊 Thuế %:" VerticalAlignment="Center" FontWeight="SemiBold"/>
								<TextBox x:Name="TaxPercentTextBox" Width="56" Height="28" Text="0" TextChanged="TotalsInput_TextChanged" Margin="6,0,0,0" TextAlignment="Center"/>
								<TextBlock Text="Thuế:" VerticalAlignment="Center" Margin="12,0,0,0" FontWeight="SemiBold"/>
								<TextBlock x:Name="TaxAmountTextBlock" Text="0₫" Width="80" TextAlignment="Left" Margin="6,0,0,0" FontWeight="Bold"/>
							</StackPanel>

							<StackPanel Grid.Row="2" Grid.ColumnSpan="2" Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,8,0,8">
								<TextBlock Text="🎁 Giảm giá:" VerticalAlignment="Center" FontWeight="SemiBold"/>
							<ComboBox x:Name="DiscountModeComboBox" Width="70" Height="28" Margin="6,0,0,0" SelectedIndex="0" SelectionChanged="TotalsSelectionChanged">
									<ComboBoxItem Content="VND"/>
									<ComboBoxItem Content="%"/>
								</ComboBox>
								<TextBox x:Name="DiscountValueTextBox" Width="80" Height="28" Text="0" TextChanged="TotalsInput_TextChanged" Margin="6,0,0,0" TextAlignment="Center"/>
								
							</StackPanel>
                            <StackPanel Grid.Row="2" Grid.ColumnSpan="2" Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,59,0,8">
                            <TextBlock x:Name="TierDiscountInlineText" Text="(+ Ưu đãi hạng: 0₫)" Margin="8,0,0,0" />
                            </StackPanel>
                            <Border Grid.Row="3" Grid.ColumnSpan="2" Background="#E0E0E0" Height="1" Margin="0,8,0,8"/>

							<TextBlock Grid.Row="4" Grid.Column="0" Text="💵 Tổng cộng:" HorizontalAlignment="Left" FontWeight="Bold" FontSize="16" Margin="0,0,8,8" Foreground="#D32F2F"/>
							<TextBlock x:Name="TotalTextBlock" Grid.Row="4" Grid.Column="1" Text="0₫" HorizontalAlignment="Left" TextAlignment="Left" FontWeight="Bold" FontSize="22" Foreground="#D32F2F"/>

							<StackPanel Grid.Row="5" Grid.ColumnSpan="2" Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,8,0,8">
								<TextBlock Text="💳 PTTT:" VerticalAlignment="Center" FontWeight="SemiBold"/>
								<ComboBox x:Name="PaymentMethodComboBox" Width="100" Height="28" Margin="6,0,12,0" SelectedIndex="0" FontSize="12" SelectionChanged="PaymentMethodComboBox_SelectionChanged">
									<ComboBoxItem Content="💵 Tiền mặt"/>
									<ComboBoxItem Content="💳 Thẻ"/>
									<ComboBoxItem Content="🏦 Chuyển khoản"/>
									<ComboBoxItem Content="📱 Ví điện tử"/>
								</ComboBox>
								<TextBlock Text="Đã trả:" VerticalAlignment="Center" FontWeight="SemiBold"/>
								<TextBox x:Name="PaidTextBox" Width="100" Height="28" Text="0" TextChanged="TotalsInput_TextChanged" Margin="6,0,0,0" TextAlignment="Center"/>
							</StackPanel>

							<StackPanel Grid.Row="6" Grid.ColumnSpan="2" Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,8,0,12">
								<TextBlock Text="🔄 Tiền thừa:" VerticalAlignment="Center" FontWeight="Bold"/>
								<TextBlock x:Name="ChangeTextBlock" Text="0₫" Width="80" TextAlignment="Left" Margin="6,0,0,0" FontWeight="Bold" Foreground="#388E3C"/>
							</StackPanel>

							<!-- QR Code Section -->
                            <Border Grid.Row="7" Grid.ColumnSpan="2" Background="#F8F9FA" CornerRadius="8" Padding="15" Margin="0,8,0,8" BorderBrush="#E0E0E0" BorderThickness="1">
								<Grid>
									<Grid.ColumnDefinitions>
										<ColumnDefinition Width="*"/>
										<ColumnDefinition Width="Auto"/>
									</Grid.ColumnDefinitions>
									
									<!-- QR Info -->
									<StackPanel Grid.Column="0" VerticalAlignment="Center">
										<TextBlock Text="💳 QR CODE THANH TOÁN" FontSize="14" FontWeight="Bold" 
												   Foreground="#2E7D32" Margin="0,0,0,4"/>
										<TextBlock Text="Quét mã QR để thanh toán nhanh" FontSize="11" 
												   Foreground="#666666" Margin="0,0,0,2"/>
										<TextBlock Text="Hỗ trợ: MoMo, ZaloPay, TPBank, Ngân hàng" FontSize="10" 
												   Foreground="#888888"/>
									</StackPanel>
									
									<!-- QR Code -->
									<Border Grid.Column="1" Background="White" CornerRadius="6" Padding="8" 
											BorderBrush="#E0E0E0" BorderThickness="1">
										<StackPanel>
											<Image x:Name="InvoiceQRCode" Width="80" Height="80" 
												   Stretch="Uniform" HorizontalAlignment="Center"/>
											<TextBlock Text="Quét để thanh toán" FontSize="9" 
													   Foreground="#666666" HorizontalAlignment="Center" 
													   Margin="0,2,0,0"/>
										</StackPanel>
									</Border>
								</Grid>
							</Border>
							
							<Grid Grid.Row="8" Grid.ColumnSpan="2">
	<Grid.RowDefinitions>
		<RowDefinition Height="Auto"/>
		<RowDefinition Height="Auto"/>
	</Grid.RowDefinitions>
	<Grid.ColumnDefinitions>
		<ColumnDefinition Width="Auto"/>
		<ColumnDefinition Width="Auto"/>
	</Grid.ColumnDefinitions>

	<Button x:Name="SaveInvoiceButton" Grid.Row="0" Grid.Column="0" Content="💾 Lưu Hóa Đơn" Width="140" Height="40" 
			Background="#4CAF50" Foreground="White" FontWeight="SemiBold" Click="SaveInvoiceButton_Click" Margin="0,0,8,8"/>
	<Button x:Name="PrintInvoiceButton" Grid.Row="0" Grid.Column="1" Content="🖨️ In Hóa Đơn" Width="140" Height="40" 
			Background="#FF9800" Foreground="White" FontWeight="SemiBold" Click="PrintInvoiceButton_Click" Margin="0,0,0,8"/>
                                <Button x:Name="ClearInvoiceButton" Grid.Row="1" Grid.Column="0" Content="🧹 Xóa Hóa Đơn" Width="140" Height="40"
			Background="#9E9E9E" Foreground="White" FontWeight="SemiBold" Click="ClearInvoiceButton_Click" Margin="0,0,8,0"/>
                            </Grid>
						</Grid>
					</Border>
				</Grid>
			</Border>
		</Grid>
	</Grid>
	</Window>
